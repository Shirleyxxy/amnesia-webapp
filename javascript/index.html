<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>

.user-item-interactions-cell {
    float: left;
    width: 40px;
    height: 40px;
}

.num-interactions-cell {
    float: left;
    width: 40px;
    height: 40px;
}

.cooccurrences-cell {
    float: left;
    width: 40px;
    height: 40px;
}

.similarities-cell {
    float: left;
    width: 40px;
    height: 40px;
}

</style>
</head>
<body>
<!-- <button id="initButton" onclick="javascript:socket.send(initRequest);">Initialize</button> -->

<button id="initButton">Initialize</button>
<p>Please input the change and click the "Submit" button. The change request will be sent to the server.</p>

<form id="form">
    <input type="text" id="msg" size=80><br>
    <input type="submit" value="Submit">
</form>

<br style="clear: left;"/>

<form id="remove_form">
    User Id to Remove: <input type="text" id="user_to_remove"><br>
    <input type="submit" value="Remove">
</form>

<br style="clear: left;"/>

<h3 id="test">Test Cell</h3>

<h3>History Matrix</h3>

<div id="history_matrix">
    <div id="history_user1" style="clear: left;">
      <div id="history_matrix_1_0" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_1_1" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_1_2" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_1_3" class="user-item-interactions-cell">0</div>
    </div>

    <div id="history_user2" style="clear: left;">
      <div id="history_matrix_2_0" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_2_1" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_2_2" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_2_3" class="user-item-interactions-cell">0</div>
    </div>

    <div id="history_user3" style="clear: left;">
      <div id="history_matrix_3_0" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_3_1" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_3_2" class="user-item-interactions-cell">0</div>
      <div id="history_matrix_3_3" class="user-item-interactions-cell">0</div>
    </div>

</div>

<br style="clear: left;"/>

<h3>Number of Interactions per Item</h3>

<p>
    \( \mathbf{n} = \sum_i \; \mathbf{H}_i \)
</p>

<div id="interactions_per_item">
    <div style="clear: left;">
        <div id="interactions_per_item_0" class="num-interactions-cell">0</div>
        <div id="interactions_per_item_1" class="num-interactions-cell">0</div>
        <div id="interactions_per_item_2" class="num-interactions-cell">0</div>
        <div id="interactions_per_item_3" class="num-interactions-cell">0</div>
    </div>
</div>

<br style="clear: left;"/>

<h3>Item Cooccurrence Matrix</h3>

<p>
    \( \mathbf{C} = \; \mathbf{H}_i^\top \mathbf{H}_i \)
</p>

<div id="cooccurrences">
    <div style="clear: left;">
        <div id="cooccurrences_0_0" class="cooccurrences-cell">-</div>
        <div id="cooccurrences_0_1" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_0_2" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_0_3" class="cooccurrences-cell">0</div>
    </div>

    <div style="clear: left;">
        <div id="cooccurrences_1_0" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_1_1" class="cooccurrences-cell">-</div>
        <div id="cooccurrences_1_2" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_1_3" class="cooccurrences-cell">0</div>
    </div>

    <div style="clear: left;">
        <div id="cooccurrences_2_0" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_2_1" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_2_2" class="cooccurrences-cell">-</div>
        <div id="cooccurrences_2_3" class="cooccurrences-cell">0</div>
    </div>

    <div style="clear: left;">
        <div id="cooccurrences_3_0" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_3_1" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_3_2" class="cooccurrences-cell">0</div>
        <div id="cooccurrences_3_3" class="cooccurrences-cell">-</div>
    </div>
</div>

<br style="clear: left;"/>

<h3>Item Similarity Matrix</h3>

<p>
    \( \mathbf{S} = \; [C_{ij} / (n_i + n_j - C_{ij})]_{ij} \)
</p>

<div id="similarities">

    <div style="clear: left;">
        <div id="similarities_0_0" class="similarities-cell">-</div>
        <div id="similarities_0_1" class="similarities-cell">0.0</div>
        <div id="similarities_0_2" class="similarities-cell">0.0</div>
        <div id="similarities_0_3" class="similarities-cell">0.0</div>
    </div>

    <div style="clear: left;">
        <div id="similarities_1_0" class="similarities-cell">0.0</div>
        <div id="similarities_1_1" class="similarities-cell">-</div>
        <div id="similarities_1_2" class="similarities-cell">0.0</div>
        <div id="similarities_1_3" class="similarities-cell">0.0</div>
    </div>

    <div style="clear: left;">
        <div id="similarities_2_0" class="similarities-cell">0.0</div>
        <div id="similarities_2_1" class="similarities-cell">0.0</div>
        <div id="similarities_2_2" class="similarities-cell">-</div>
        <div id="similarities_2_3" class="similarities-cell">0.0</div>
    </div>

    <div style="clear: left;">
        <div id="similarities_3_0" class="similarities-cell">0.0</div>
        <div id="similarities_3_1" class="similarities-cell">0.0</div>
        <div id="similarities_3_2" class="similarities-cell">0.0</div>
        <div id="similarities_3_3" class="similarities-cell">-</div>
    </div>
</div>

<br style="clear: left;"/>

<h3>Change Log</h3>

<pre id="messages"></pre>

<script>

var initRequest = '{"change":"Add", "interactions":[[1,1], [1,2], [2,0], [2,1], [2,3], [3,1], [3,3]]}';

// function to display the initial request
function displayInitialRequest() {
  // enqueue the message to be transmitted to the model
  // display interactions per item, cooccurrence matrix, similarity matrix
  socket.send(initRequest);
  // parse the message to display the history matrix
  var initRequestDict = JSON.parse(initRequest);
  var initInteractions = initRequestDict["interactions"];
  var initInteractionsLength = initInteractions.length;
  for (var i = 0; i < initInteractionsLength; i++) {
    var user = initInteractions[i][0].toString();
    var item = initInteractions[i][1].toString();
    document.getElementById("history_matrix_" + user + "_" + item).innerHTML = 1;
  // disable the initialize button after the first click
  document.getElementById("initButton").disabled = true;
  }
}
// trigger the function to display the initial request
document.getElementById("initButton").onclick = displayInitialRequest;

// web socket
var socket = new WebSocket("ws://" + window.location.host + "/ws");
// when a message is received from the server
socket.onmessage = function (event) {

  var messages = document.getElementById("messages");
  messages.append(event.data + "\n");

  var change = JSON.parse(event.data);

  if (change['data'] == 'item_interactions_n' && change['change'] == 1) {
    var item = change['item'];
    var count = change['count'];
    document.getElementById("interactions_per_item_" + item).innerHTML = count;
  }

  if (change['data'] == 'cooccurrences_c' && change['change'] == 1) {
    var item_a = change['item_a'];
    var item_b = change['item_b'];
    var count = change['num_cooccurrences'];
    document.getElementById("cooccurrences_" + item_a + "_" + item_b).innerHTML = count;
    document.getElementById("cooccurrences_" + item_b + "_" + item_a).innerHTML = count;
  }

  if (change['data'] == 'similarities_s' && change['change'] == 1) {
    var item_a = change['item_a'];
    var item_b = change['item_b'];
    var similarity = change['similarity'];
    document.getElementById("similarities_" + item_a + "_" + item_b).innerHTML = Number(similarity).toFixed(2);
    document.getElementById("similarities_" + item_b + "_" + item_a).innerHTML = Number(similarity).toFixed(2);
  }

};

// var removeRequest = '{"change":"Remove", "interactions":[[1,1], [1,2]]}';

// display the changes from a request message
var form = document.getElementById("form");
form.addEventListener('submit', function (event) {
  event.preventDefault();
  var input = document.getElementById("msg");
  // send the message from the browser to the model to reflect the changes
  socket.send(input.value);
  // parse the message to reflect the change of the history matrix
  var inputDict = JSON.parse(input.value);
  var inputInteractions = inputDict["interactions"];

  // parse REMOVE message
  if (inputDict['change'] == 'Remove') {
    var removeUserId = inputInteractions[0][0];
    let userToRemove = document.getElementById('history_user' + removeUserId);
    document.getElementById("history_matrix").removeChild(userToRemove);
  }

  // parse ADD message
  if (inputDict['change'] == 'Add') {
    var addUserId = inputInteractions[0][0];
    // create a new element for the new user
    let userToAdd = document.createElement("div");
    userToAdd.id = "history_user" + addUserId;
    userToAdd.style = "clear: left;";
    document.getElementById("history_matrix").appendChild(userToAdd);

    // create the four user-item elements for the new user element
    for (var i = 0; i < 4; i++) {
      let newUserItem = document.createElement("div");
      newUserItem.id = "history_matrix_" + addUserId + "_" + i;
      newUserItem.className = "user-item-interactions-cell";
      newUserItem.innerHTML = 0;
      document.getElementById("history_user" + addUserId).appendChild(newUserItem);
    }

    inputInteractions.forEach(element => {
        var row = element[0];
        var col = element[1];
        document.getElementById("history_matrix_" + row + "_" + col).innerHTML = 1;
    });
  }

  // reset to an empty message
  input.value = "";

});

// remove button
var removeForm = document.getElementById("remove_form");

removeForm.addEventListener('submit', function (event) {
  event.preventDefault();
  // remove the user in the history matrix
  var removeUserId = document.getElementById("user_to_remove").value;
  let userToRemove = document.getElementById('history_user' + removeUserId);
  document.getElementById("history_matrix").removeChild(userToRemove);

  // create the REMOVE message for the web socket
  var interactions = [];
  for (var i = 0; i < 4; i++) {
    if (document.getElementById('history_matrix_' + removeUserId + '_' + i).innerHTML == "1") {
      interactions.push([Number(removeUserId), i]);
    }
  }

  var removeMessageDict = {"change":"Remove"};
  removeMessageDict["interactions"] = interactions;
  var removeMessage = JSON.stringify(removeMessageDict);
  socket.send(removeMessage);

});


</script>
</body>
</html>
